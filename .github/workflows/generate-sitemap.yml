name: Generate Sitemap

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # agar git log bisa membaca seluruh riwayat file

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'

      - name: Generate sitemap.xml
        run: |
          echo '<?xml version="1.0" encoding="UTF-8"?>' > sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> sitemap.xml

          # Daftar file yang ingin dikecualikan
          EXCLUDE=("googled6582ad7947937b1.html" "404.html" "274925.html" "index.html")

          for file in $(find . -name "*.html" | sort); do
            cleanpath="${file#./}"

            # Skip jika file ada dalam daftar EXCLUDE
            skip=false
            for ex in "${EXCLUDE[@]}"; do
              [[ "$cleanpath" == "$ex" ]] && skip=true && break
            done
            $skip && continue

            # Hapus ekstensi .html dan tambahkan ke sitemap
            url="https://foldir.xyz/${cleanpath%.html}"

            # Ambil waktu modifikasi terakhir dari Git, fallback ke waktu sekarang jika gagal
            lastmod=$(TZ=UTC git log -1 --format="%cd" --date=format-local:"%Y-%m-%dT%H:%M:%SZ" "$file" 2>/dev/null || date -u +"%Y-%m-%dT%H:%M:%SZ")

            echo "  <url>" >> sitemap.xml
            echo "    <loc>$url</loc>" >> sitemap.xml
            echo "    <lastmod>$lastmod</lastmod>" >> sitemap.xml
            echo "  </url>" >> sitemap.xml
          done

          echo '</urlset>' >> sitemap.xml

      - name: Commit and push sitemap.xml
        run: |
          git add sitemap.xml
          git commit -m "Update sitemap.xml without .html and exclude specific files" || echo "No changes to commit"
          git push origin main
